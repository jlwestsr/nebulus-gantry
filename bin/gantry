#!/bin/bash

# Nebulus CLI Entrypoint

COMMAND=$1
BIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

case $COMMAND in
  help)
    echo "Gantry CLI"
    echo "=========="
    echo "Usage: bin/gantry [command]"
    echo ""
    echo "Available Commands:"
    echo "  start       Start the application server (wrapper for run_app)"
    echo "  test        Run unit tests (wrapper for run_tests)"
    echo "  status      Check the operational status of services"
    echo "  help        Show this help message"
    exit 0
    ;;
    
  status)
    echo "--- Gantry System Status ---"
    
    # Check Uvicorn (App Server)
    if pgrep -f "nebulus_gantry.main:app" > /dev/null; then
      PID=$(pgrep -f "nebulus_gantry.main:app" | head -n 1)
      echo "✅ App Server (Uvicorn): Running (PID: $PID)"
    else
      echo "❌ App Server (Uvicorn): Stopped"
    fi

    # Check Ollama (AI Engine)
    if pgrep -x "ollama" > /dev/null || pgrep -f "ollama serve" > /dev/null; then
      echo "✅ AI Engine (Ollama):   Running"
    else
      echo "❌ AI Engine (Ollama):   Stopped"
    fi
    
    echo "-----------------------------"
    exit 0
    ;;

  start)
    "$BIN_DIR/run_app"
    ;;

  test)
    "$BIN_DIR/run_tests"
    ;;

  *)
    echo "Unknown command: '$COMMAND'"
    echo "Run 'bin/gantry help' for available commands."
    exit 1
    ;;
esac
